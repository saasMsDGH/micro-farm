name: ðŸ“‚ Release Coordinator

on:
  push:
    branches: [ "master" ]
    paths: [ "versions.yaml" ]

jobs:
  tagger:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2
          token: ${{ secrets.PAT_TOKEN }}

      - name: Detect and Tag
        run: |
          sudo wget https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/bin/yq && sudo chmod +x /usr/bin/yq
          
          for s in $(yq '.services | keys | .[]' versions.yaml); do
            OLD_V=$(git show HEAD^:versions.yaml | yq ".services.$s")
            NEW_V=$(yq ".services.$s" versions.yaml)
            
            if [ "$OLD_V" != "$NEW_V" ]; then
              TAG_NAME="${s}@v${NEW_V}"
              git tag $TAG_NAME
              git push origin $TAG_NAME
            fi
          done