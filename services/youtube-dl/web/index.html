<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>GoTube - DGSynthex</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-900 text-white min-h-screen flex items-center justify-center p-4">
    <div class="max-w-2xl w-full space-y-8 bg-slate-800 p-10 rounded-3xl shadow-2xl border border-slate-700">
        <h1 class="text-4xl font-black text-center text-red-500 tracking-tight">GOTUBE</h1>
        <div class="flex flex-col gap-4">
            <input type="text" id="ytUrl" placeholder="URL YouTube (ex: https://www.youtube.com/watch?v=...)" 
                   class="w-full bg-slate-700 border-none rounded-xl p-4 text-white focus:ring-2 focus:ring-red-500 outline-none">
            <select id="res" class="bg-slate-700 rounded-xl p-4 border-none outline-none focus:ring-2 focus:ring-red-500">
                <option value="720">720p (Direct)</option>
                <option value="1080">1080p (HD Muxing)</option>
            </select>
            <button id="dlBtn" onclick="startDownload()" class="bg-red-600 px-6 py-4 rounded-xl font-bold hover:bg-red-500 transition-all">Télécharger</button>
        </div>
        <p id="msg" class="text-sm text-slate-400 text-center"></p>
    </div>

    <script>
        async function startDownload() {
            const url = document.getElementById('ytUrl').value;
            const q = document.getElementById('res').value;
            const msg = document.getElementById('msg');
            const btn = document.getElementById('dlBtn');
            const match = url.match(/(?:v=|\/)([a-zA-Z0-9_-]{11})/);
            
            if (!match) return alert("URL YouTube invalide");

            msg.innerText = "⏳ Préparation du flux...";
            msg.classList.replace('text-slate-400', 'text-blue-400');
            btn.disabled = true;
            btn.classList.add('opacity-50');

            try {
                const response = await fetch('/api/stream?v=' + match[1] + '&q=' + q);
                
                if (!response.ok) {
                    const text = await response.text();
                    throw new Error(text || "Erreur de restriction YouTube");
                }

                msg.innerText = "✅ Téléchargement commencé !";
                msg.classList.replace('text-blue-400', 'text-green-400');
                
                // Déclenchement du téléchargement navigateur
                const blob = await response.blob();
                const downloadUrl = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = downloadUrl;
                a.download = match[1] + ".mp4";
                document.body.appendChild(a);
                a.click();
                a.remove();
            } catch (err) {
                msg.innerText = "❌ " + err.message;
                msg.classList.replace('text-blue-400', 'text-red-400');
            } finally {
                btn.disabled = false;
                btn.classList.remove('opacity-50');
            }
        }
    </script>
</body>
</html>